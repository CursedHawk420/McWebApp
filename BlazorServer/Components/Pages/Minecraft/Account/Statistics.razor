@page "/Minecraft/Account/Statistics"

@using Newtonsoft.Json

@inherits LanguageBase

@inject IUserService _userService
@inject IRedisUpdateService _redisUpdateService
@inject IJSRuntime _js

@attribute [PermissionsAuthorize("connectedaccount")]

<PageTitle>@l["acc-stats"]</PageTitle>
<h1>@l["acc-stats"]</h1>
@if (loaded)
{
    <h3>Overall</h3>
    <p>@MergedJson</p>
    @foreach (var item in ServersStats)
    {
        <h3>@l[item.Key]</h3>
        <p>@item.Value</p>
    }
}

@code{
    string MergedJson;
    Dictionary<string, string> ServersStats = new Dictionary<string, string>();

    private bool loaded = false;

    protected override async void OnInitialized()
    {
        base.OnInitialized();

        _redisUpdateService.StatsUpdate += UpdateStats;
        SetStats();
    }

    public async void SetStats()
    {
        var keys = await RedisService.GetKeysList("players:stats:" + _userService.MinecraftUser.NickName + ":*");
        ServersStats.Clear();
        foreach (var key in keys)
        {
            var item = RedisService.GetJson(key);
            var name = key.Substring(key.LastIndexOf(':') + 1, key.Length - key.LastIndexOf(':') - 1);
            ServersStats.TryAdd(name, item);
        }
        loaded = true;



        //dictionary merge
        var toProccess = new List<Dictionary<string, Dictionary<string, int>>>();
        var proccessed = new Dictionary<string, Dictionary<string, int>>();

        foreach (var item in ServersStats)
        {
            toProccess.Add(JsonConvert.DeserializeObject<Dictionary<string, Dictionary<string, int>>>(item.Value));
        }


        foreach (var item in toProccess)
        {
            foreach (var items in item)
            {
                var currkey = items.Key;
                proccessed.TryAdd(currkey, new Dictionary<string, int>());
                var currDict = proccessed[currkey];
                foreach(var it in items.Value)
                {
                    var good = currDict.TryAdd(it.Key, it.Value);
                    if (!good)
                    {

                        proccessed[currkey][it.Key] = currDict[it.Key] + it.Value;
                    }
                }
            }
        }
        MergedJson = JsonConvert.SerializeObject(proccessed);

        RefreshAsync();
    }

    public async void UpdateStats(object? sender, string uuid)
    {
        if (uuid.Contains(_userService.MinecraftUser.NickName))
        {
            SetStats();
        }
    }

    public override void Dispose(bool disposing)
    {
        if (disposing)
        {
            _redisUpdateService.StatsUpdate -= UpdateStats;
        }
    }
}